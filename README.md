# 粉丝头像马赛克生成系统

通过粉丝头像自动生成艺术马赛克图片的系统，包含图片生成、后处理和互动定位三大模块

## 系统组成

### 🖼 马赛克生成器 (mosaic_v5.py)
**核心功能**：将源图片像素映射到粉丝头像，生成初步马赛克效果
```
python mosaic_v5.py -i 原图.jpg -t 头像库/ -o 马赛克初稿.png \
  -e 8 -m 50 -M smart
```
# mosaic_v5.py 参数详解

## 核心参数

| 参数 | 短参数 | 值类型 | 默认值 | 说明 |
|------|--------|--------|--------|------|
| `--image` | `-i` | 路径 | **必填** | 原始图片路径（支持JPG/PNG/TIFF） |
| `--tiles_dir` | `-t` | 路径 | **必填** | 头像库目录路径 |
| `--outfile` | `-o` | 路径 | output.png | 输出文件路径 |

## 马赛克生成控制

| 参数 | 短参数 | 值类型 | 默认值 | 说明                                                                                |
|------|--------|--------|-----|-----------------------------------------------------------------------------------|
| `--enlargement` | `-e` | 整数 | 4   | **输出图放大倍数**<br>计算公式：输出尺寸 = 原图宽高 × 放大倍数<br>（建议值：8-12）                              |
| `--max_usage` | `-m` | 整数 | 5   | **单个头像最大使用次数**<br>设为0表示不限制（建议值：1-5）                                               |
| `--max_usage_way` | `-M` | 0/1 | 0   | **使用次数超限处理策略**<br>`0`: 每次超限增加`usage_factor×超限次数`的惩罚<br>`1`: 只增加一次`usage_factor`惩罚 |

## 随机化控制

| 参数 | 值类型 | 默认值  | 说明                                                |
|------|--------|------|---------------------------------------------------|
| `--top_n_rand` | 整数 | 5    | **候选池大小**<br>从相似度前N个头像中随机选择                       |
| `--select_temp` | 整数 | 50000 | **随机因子**<br>值越大选择相似度低的概率越高<br>（推荐范围：15000-80000） |

## GPU加速配置

| 参数 | 短参数 | 值格式 | 默认值 | 说明                      |
|------|--------|-----|-----|-------------------------|
| `--gpu_split_zone` | `-g` | 1   | 1   | **GPU分块策略**（需根据GPU数量调整） |

## 处理顺序控制

| 参数 | 值类型 | 说明                                                                                     | 推荐场景             |
|------|--------|----------------------------------------------------------------------------------------|------------------|
| `--zone_order` | 0-4 | **区域处理顺序**：<br>`0` 左→右顺序处理<br>`1` 全图随机乱序<br>`2` 中心→边缘扩散<br>`3` 指定中心螺旋展开<br>`4` 边缘→中心螺旋 | 肖像类用2/3<br>风景类用4 |
| `--zone_center` | X,Y | 中心点坐标（需与zone_order=3配合）<br>格式：`50,50`                                                  | 重要元素中心定位（单位为百分比） |

## 高级参数

| 参数 | 值类型 | 默认值 | 说明                                       |
|------|--------|-----|------------------------------------------|
| `--reset` | 整数 | 0   | **计数重置间隔**<br>每处理N个区域后重置使用计数<br>（0表示不重置） |
| `--usage_factor` | 浮点数 | 1e6 | 超限惩罚系数<br>（建议范围：1e6-1e9）                 |
| `--nccl_path` | 路径 | 空   | NCCL库路径（集群加速时使用）                         |

## 使用示例

  
### 🎨 后处理器 (postprocess.py)
**优化功能**：增强使用的粉丝数量

```
python postprocess.py -i 原图.jpg -n 映射表.csv \
  -t 马赛克初稿.png -o 最终作品.png
```

### 🌐 互动定位网站 (web.py)
**功能特性**：
- 实时展示马赛克大图
- 姓名搜索定位

**启动方式**：
```
python web.py -i 最终作品.png -n 映射表.csv
```

### 典型应用场景

#### 明星应援活动

    # 生成阶段
    python mosaic_v5.py -i idol.jpg -t fans_avatars/ -o draft.png -e 10
    # 后处理阶段
    python postprocess.py -i idol.jpg -n fan_mapping.csv -o final.tiff
    # 部署查询网站
    nohup python web.py -i final.tiff -n fan_mapping.csv > web.log &

### 高级配置项
#### GPU加速配置

# 16卡的GPU分块处理
```
python mosaic_v5.py -g 16 ...
```

# 重置图片共享内存缓存
```
python mosaic_v5.py -C -i ...
```

# 继续上次生成进度
```
python mosaic_v5.py --continue -i ...
```
---

# 感谢

- [晨羽智云](https://www.chenyu.cn/) - 提供GPU运算平台
- [布拉莫维奇](https://www.cnblogs.com/blamwq/p/11706844.html) - 原始马赛克图片实现算法
- [DeepSeek](https://www.deepseek.com/) - 生成了部份代码
